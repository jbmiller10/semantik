name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Grant permissions for PR comments
permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  check-tests:
    runs-on: ubuntu-latest
    name: Verify Test Coverage
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper diff
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v45
      with:
        files: |
          apps/webui-react/src/components/**/*.tsx
          apps/webui-react/src/components/**/*.ts
          !apps/webui-react/src/components/**/*.test.tsx
          !apps/webui-react/src/components/**/*.test.ts
    
    - name: Check for missing tests
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "## Changed Component Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The following component files were modified:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "- $file" >> $GITHUB_STEP_SUMMARY
          
          # Extract component name and check for test file
          component_name=$(basename "$file" .tsx | sed 's/\.ts$//')
          test_file="apps/webui-react/src/components/__tests__/${component_name}.test.tsx"
          
          if [ ! -f "$test_file" ]; then
            echo "  ⚠️  Missing test file: $test_file" >> $GITHUB_STEP_SUMMARY
            echo "::warning file=$file::Missing test file for this component"
          else
            echo "  ✅ Test file exists: $test_file" >> $GITHUB_STEP_SUMMARY
          fi
        done

  test-affected:
    runs-on: ubuntu-latest
    name: Test Affected Components
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Install dependencies
      run: |
        npm ci
        cd apps/webui-react && npm ci
    
    - name: Get changed test files
      id: changed-tests
      uses: tj-actions/changed-files@v45
      with:
        files: |
          apps/webui-react/src/**/*.test.tsx
          apps/webui-react/src/**/*.test.ts
    
    - name: Run changed tests
      if: steps.changed-tests.outputs.any_changed == 'true'
      working-directory: ./apps/webui-react
      run: |
        echo "Running tests for changed files..."
        # Convert absolute paths to relative paths for vitest
        TEST_FILES=""
        for file in ${{ steps.changed-tests.outputs.all_changed_files }}; do
          # Extract the relative path from apps/webui-react/
          RELATIVE_PATH=$(echo "$file" | sed 's|^.*/apps/webui-react/||')
          TEST_FILES="$TEST_FILES $RELATIVE_PATH"
        done
        echo "Test files: $TEST_FILES"
        npm test -- --run $TEST_FILES
    
    - name: Run all collection component tests
      if: contains(github.event.pull_request.title, 'collection') || contains(github.event.pull_request.body, 'collection')
      working-directory: ./apps/webui-react
      run: |
        echo "Running all collection component tests..."
        npm run test:collections

  coverage-check:
    runs-on: ubuntu-latest
    name: Coverage Report
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Install dependencies
      run: |
        npm ci
        cd apps/webui-react && npm ci
    
    - name: Run coverage for collection components
      working-directory: ./apps/webui-react
      run: npm run test:collections -- --coverage
    
    - name: Generate coverage summary
      working-directory: ./apps/webui-react
      run: |
        echo "## Frontend Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Collection Components Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat coverage/coverage-summary.json | jq -r '.total | "Statements: \(.statements.pct)%\nBranches: \(.branches.pct)%\nFunctions: \(.functions.pct)%\nLines: \(.lines.pct)%"' >> $GITHUB_STEP_SUMMARY || echo "Coverage report not available" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: Comment PR with coverage
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        header: coverage
        message: |
          ## 📊 Test Coverage Report
          
          Frontend collection components test coverage has been updated.
          
          See the [Actions summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed coverage information.