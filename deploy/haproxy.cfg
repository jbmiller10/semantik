# HAProxy Configuration for Semantik WebSocket Scaling
# This configuration enables horizontal scaling of WebSocket connections
# across multiple WebUI instances with sticky sessions

global
    # Process management
    daemon
    maxconn 50000
    
    # Logging
    log stdout local0
    log stdout local1 notice
    
    # Security
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE+AESGCM:ECDHE+AES256:ECDHE+AES128:!PSK:!DHE:!RSA:!DSS:!aNull:!MD5
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11
    
    # Performance tuning
    tune.bufsize 32768
    tune.maxrewrite 1024
    
    # Statistics
    stats socket /var/run/haproxy.sock mode 600 level admin
    stats timeout 30s

defaults
    # Connection timeouts
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout tunnel 1h        # Long timeout for WebSocket
    timeout http-request 10s
    timeout http-keep-alive 2s
    timeout queue 1m
    
    # Logging
    log global
    option httplog
    option dontlognull
    option log-health-checks
    
    # HTTP options
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    
    # Error handling
    retries 3
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css application/javascript application/json

# Statistics dashboard
stats enable
stats uri /haproxy-stats
stats refresh 30s
stats auth admin:secure_password_here

# Frontend for HTTP/HTTPS traffic
frontend http_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/semantik.pem alpn h2,http/1.1
    
    # Redirect HTTP to HTTPS
    redirect scheme https if !{ ssl_fc }
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Request rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 100 }
    
    # ACLs for routing
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_websocket_path path_beg /ws/
    acl is_sse_path path_beg /ws/sse/
    acl is_api_path path_beg /api/
    acl is_static_path path_beg /static/ /assets/
    
    # Use appropriate backend
    use_backend websocket_backend if is_websocket or is_websocket_path
    use_backend sse_backend if is_sse_path
    use_backend api_backend if is_api_path
    use_backend static_backend if is_static_path
    default_backend webui_backend

# Backend for WebSocket connections with sticky sessions
backend websocket_backend
    # Load balancing algorithm
    balance leastconn
    
    # Sticky sessions based on cookie
    cookie SERVERID insert indirect nocache httponly secure
    
    # Session persistence table
    stick-table type string len 32 size 100k expire 1h
    stick on cookie(session_id)
    
    # WebSocket specific options
    option http-server-close
    option forceclose
    no option httpclose
    
    # Health checks
    option httpchk GET /ws/health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # Backend servers
    server webui1 webui1:8080 check cookie ws1 maxconn 1000 weight 100
    server webui2 webui2:8080 check cookie ws2 maxconn 1000 weight 100
    server webui3 webui3:8080 check cookie ws3 maxconn 1000 weight 100
    
    # Backup server
    server webui_backup webui_backup:8080 backup check cookie wsb maxconn 500

# Backend for Server-Sent Events
backend sse_backend
    # SSE needs different settings than WebSocket
    balance roundrobin
    
    # No buffering for SSE
    option http-no-delay
    
    # Longer timeout for SSE streams
    timeout server 24h
    timeout client 24h
    
    # Disable buffering
    http-response set-header X-Accel-Buffering no
    http-response set-header Cache-Control no-cache
    
    # Backend servers
    server webui1 webui1:8080 check maxconn 500
    server webui2 webui2:8080 check maxconn 500
    server webui3 webui3:8080 check maxconn 500

# Backend for API requests
backend api_backend
    # Load balancing for API
    balance roundrobin
    
    # Session affinity for API (optional)
    cookie APISESSION insert indirect nocache httponly secure
    
    # API rate limiting per backend
    stick-table type ip size 100k expire 1m store http_req_rate(1m)
    
    # Health checks
    option httpchk GET /api/health/readyz HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # Backend servers with connection limits
    server webui1 webui1:8080 check cookie api1 maxconn 200
    server webui2 webui2:8080 check cookie api2 maxconn 200
    server webui3 webui3:8080 check cookie api3 maxconn 200

# Backend for static content
backend static_backend
    # Static content can be aggressively cached
    balance roundrobin
    
    # Cache headers for static content
    http-response set-header Cache-Control "public, max-age=31536000, immutable" if { path_end .js .css .woff2 .png .jpg .jpeg .gif .svg }
    
    # Compression for static files
    compression algo gzip
    compression type text/css text/javascript application/javascript
    
    # Backend servers
    server webui1 webui1:8080 check maxconn 100
    server webui2 webui2:8080 check maxconn 100
    server webui3 webui3:8080 check maxconn 100

# Default backend for web UI
backend webui_backend
    # General web UI traffic
    balance roundrobin
    
    # Session persistence for UI
    cookie UISESSION insert indirect nocache httponly secure
    
    # Health checks
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # Backend servers
    server webui1 webui1:8080 check cookie ui1 maxconn 300
    server webui2 webui2:8080 check cookie ui2 maxconn 300
    server webui3 webui3:8080 check cookie ui3 maxconn 300

# Optional: Backend for admin/monitoring
backend admin_backend
    # Admin traffic (Flower, metrics, etc.)
    balance roundrobin
    
    # Stricter security for admin
    http-request deny unless { src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 }
    
    server flower flower:5555 check maxconn 10
    server prometheus prometheus:9090 check maxconn 10
    server grafana grafana:3000 check maxconn 20