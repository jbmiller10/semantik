# Docker Guide

## Quick Start

**Requirements:** Docker 24+, Compose v2, Buildx plugin

**Setup:**
```bash
make wizard  # Interactive (recommended)
# OR
cp .env.docker.example .env && make docker-up
```

Access at http://localhost:8080

## Architecture

Files: `docker-compose.yml` (main), `.cuda.yml` (GPU), `.dev.yml` (dev), `.prod.yml` (production), `Dockerfile` (multi-stage)

## Services

**Data:** Qdrant (6333, 6334), PostgreSQL (5432), Redis (6379)
**App:** WebUI (8080), Vecpipe (8000), Worker, Flower (5555, profile: backend)
**Test:** PostgreSQL Test (55432, profile: testing)

All have health checks and resource limits.

## Profiles

- **Default**: Core services (`docker compose up -d`)
- **backend**: + Flower (`--profile backend`)
- **testing**: + Test PostgreSQL (`--profile testing`)

## Volumes

**Named:** `qdrant_storage`, `postgres_data`, `redis_data`, `postgres_test_data`

**Bind mounts:** `./data` (operations), `./models` (HF cache), `./logs`, `${DOCUMENT_PATH}` (read-only)

## GPU

Use `docker-compose.cuda.yml` for INT8 quantization:
```bash
docker compose -f docker-compose.yml -f docker-compose.cuda.yml up -d
```

Config: `CUDA_VISIBLE_DEVICES=0`, `DEFAULT_QUANTIZATION=float16`

Memory: Qwen3-0.6B uses ~1.2GB (float16), ~0.6GB (int8)

## Configuration

Required: `JWT_SECRET_KEY`, `POSTGRES_PASSWORD`, `FLOWER_USERNAME`, `FLOWER_PASSWORD`

See `.env.docker.example` for full list.

## Networking

All services on `semantik-network`. Internal DNS: `postgres:5432`, `qdrant:6333`, etc.

## Security

Containers: `no-new-privileges`, dropped capabilities, non-root (UID/GID in `.env`)

Generate secrets: `openssl rand -hex 32`

## Commands

```bash
make docker-up           # Start
make docker-down         # Stop
make docker-logs         # Logs
docker compose logs -f webui  # Service logs
docker compose exec webui /bin/bash  # Shell
docker stats             # Resource usage
make docker-build-fresh  # Rebuild
docker system prune -a   # Cleanup
```

## Development

Dev mode: `make docker-dev-up` (live reload, debug logging)

Tests: `docker compose run --rm webui pytest`

## Production

```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

Create your own `nginx.conf` for reverse proxy. Production config expects `./nginx.conf` and `./ssl/` directory.

## Troubleshooting

### Container Won't Start

```bash
# Check logs
docker compose logs webui

# Check for port conflicts
lsof -i :8080

# Verify environment
docker compose config
```

### Permission Denied

```bash
# Fix volume permissions
sudo chown -R 1000:1000 ./data ./models ./logs

# Or using docker
docker compose run --rm webui chown -R 1000:1000 /app/data
```

### Out of Memory

```bash
# Check memory usage
docker stats

# Reduce memory usage
export DEFAULT_QUANTIZATION=int8
export BATCH_SIZE=16
```

### GPU Not Available

```bash
# Check NVIDIA runtime
docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu22.04 nvidia-smi

# Install nvidia-container-toolkit
sudo apt-get install nvidia-container-toolkit
sudo systemctl restart docker
```

### Database Connection Issues

```bash
# Check PostgreSQL logs
docker compose logs postgres

# Test connection
docker compose exec postgres psql -U semantik -d semantik

# Reset database password
docker compose down
rm -rf postgres_data
make docker-up
```

## Monitoring

### Viewing Metrics

Metrics are exposed on port 9091 (not exposed by default):

```bash
# Access metrics
docker compose exec webui curl http://localhost:9091/metrics
```

### Using Flower for Task Monitoring

```bash
# Start with backend profile
docker compose --profile backend up -d

# Access Flower UI
open http://localhost:5555
# Log in with FLOWER_USERNAME/FLOWER_PASSWORD from your .env (generated by `make wizard`).
# Rerun `make wizard` to rotate these credentials if needed.
```

### Container Resource Monitoring

```bash
# Real-time stats
docker stats

# Detailed resource usage
docker compose top
```

## Best Practices

### Image Management

1. **Use specific image tags** in production
2. **Regularly update base images** for security
3. **Clean unused images** to save space
4. **Use multi-stage builds** to minimize image size

### Security

1. **Always change default passwords**
2. **Use secrets for sensitive data**
3. **Keep containers updated**
4. **Limit container capabilities**
5. **Use read-only mounts** where possible

### Performance

1. **Use SSD storage** for volumes
2. **Configure appropriate resource limits**
3. **Enable GPU for better performance**
4. **Use INT8 quantization** to reduce memory usage

### Maintenance

1. **Regular backups** of persistent data
2. **Monitor disk usage**
3. **Rotate logs** to prevent disk fill
4. **Update dependencies** monthly

## Migration from Legacy Setup

If migrating from the old job-based system:

1. **Backup existing data**
2. **Update environment variables** (job â†’ operation paths)
3. **Run database migrations** if needed
4. **Update volume mounts** to new structure
5. **Test thoroughly** before switching production

## Support

For Docker-related issues:
1. Check container logs first
2. Verify environment configuration
3. Ensure all dependencies are running
4. Consult the [troubleshooting section](#troubleshooting)
5. Check GitHub issues for similar problems
