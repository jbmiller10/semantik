# Security

Semantik validates secrets at startup and exits if placeholders are detected. Run `make wizard` to generate proper secrets.

## Required Secrets

| Variable | Used By | Notes |
| --- | --- | --- |
| `JWT_SECRET_KEY` | WebUI/API | 64+ hex chars |
| `INTERNAL_API_KEY` | Service-to-service | Auto-generated |
| `POSTGRES_PASSWORD` | Database | Required |
| `FLOWER_USERNAME`, `FLOWER_PASSWORD` | Task monitoring | Generated by wizard |
| `CONNECTOR_SECRETS_KEY` | WebUI + workers | Fernet key for encrypting connector credentials; set empty to disable |

Setup: `cp .env.docker.example .env && make wizard`

## JWT Authentication

Uses JWT (HS256) with access tokens (24h) and refresh tokens (30d).

**Flow:**
1. Login → get access + refresh tokens
2. Include `Authorization: Bearer <token>` in requests
3. Refresh when access token expires

Implementation: `/packages/webui/auth.py`

## Passwords

Hashed with bcrypt. Requirements: 8+ chars for passwords, 3+ alphanumeric/underscore chars for usernames.

## DISABLE_AUTH Mode

**WARNING:** `DISABLE_AUTH=true` bypasses all auth and grants superuser access. Only use in local dev/testing. NEVER in production.

## Authorization

Owner-based access control. Users only see their own collections. Verified via `get_collection_for_user` dependency. Superusers have full access.

## Internal API Key

For service-to-service communication. Auto-generated in dev, required in production. Stored at `{data_dir}/internal_api_key` with 0600 perms. Used in `X-Internal-Api-Key` header.

## Middleware

**Stack:** Correlation ID → CSP → CORS → Rate Limiting

**CORS:** Set via `CORS_ORIGINS` env var. Wildcards rejected in production.

**CSP:** XSS protection with strict policies. Chunking endpoints get extra-strict CSP.

**Rate Limiting:** By user ID (auth'd) or IP (anon), using slowapi + Redis.

## WebSocket Auth

JWT passed as query param: `wss://host/ws/operations?token=<jwt>`. Validates signature, expiration, and user status.

## First User

First registered user becomes superuser automatically. Register your admin account immediately after deployment.

## Document Storage Roots

By default the WebUI serves files that reside under the service's `loaded_dir` mount (the path exported inside the container) and the standard Docker documents mount (`/mnt/docs`) when it is present. If neither of those mounts exists and no explicit root has been configured, the API falls back to the absolute paths recorded by ingestion so local developer workflows keep functioning. To enforce a boundary, set `DOCUMENT_ROOT` to the canonical location; requests for files outside that tree are rejected. You can allow additional locations by setting `DOCUMENT_ALLOWED_ROOTS` to a colon-separated list of absolute paths (for example, `/data/docs:/mnt/archive`). Any configured roots automatically include the `loaded_dir` mount so files copied there remain accessible.
