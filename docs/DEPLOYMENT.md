# Deployment Guide

## Overview

Semantik is a containerized microservices app: Qdrant (vectors), PostgreSQL (metadata), Redis (queue), Vecpipe (search), WebUI (interface), Worker (background tasks).

## Deployment Options

1. **Docker Compose** (recommended) - Production, staging, consistent environments
2. **Kubernetes** - Large-scale, auto-scaling
3. **Manual** - Development, debugging

## Quick Start

**With wizard:**
```bash
make wizard  # Auto-config, generates secrets, starts services
```

**Manual:**
```bash
cp .env.docker.example .env
# Edit .env (set JWT_SECRET_KEY, POSTGRES_PASSWORD, etc)
make docker-up
```

## Configuration

**Required:**
- `JWT_SECRET_KEY` (generate: `openssl rand -hex 32`)
- `POSTGRES_PASSWORD`
- `FLOWER_USERNAME` / `FLOWER_PASSWORD` (auto-generated by wizard)

**Optional:**
- `DEFAULT_EMBEDDING_MODEL` (default: Qwen/Qwen3-Embedding-0.6B)
- `DEFAULT_QUANTIZATION` (float16/int8)
- `DOCUMENT_PATH` (default: ./documents)
- Database pool settings (see `.env.docker.example`)

## Docker Deployment

**Profiles:**
- Default: Core services
- `backend`: Adds Flower
- `testing`: Adds test PostgreSQL

**Production:**
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

Production compose includes: pinned versions, JSON logging, enhanced health checks, optional nginx.

## Service Management

```bash
make docker-up                 # Start all
make docker-down               # Stop (preserves data)
docker compose down -v         # Delete everything (caution!)
docker compose ps              # Check health
docker compose --scale vecpipe=3 up -d  # Scale services
```

## Volumes

**Persistent:** `postgres_data` (critical, backup!), `qdrant_storage` (can rebuild), `redis_data`
**Bind mounts:** `./data`, `./models`, `./logs`, `./documents`

**Backup:**
```bash
docker compose exec -T postgres pg_dump -U semantik semantik > backup.sql
docker compose exec qdrant curl -X POST http://localhost:6333/snapshots
```

## Production

**Create your own `nginx.conf`** for SSL, WebSocket proxying, security headers, rate limiting.

**Security:**
- Generate secrets: `openssl rand -hex 32`
- Network isolation (frontend/backend networks)
- Read-only containers where possible
- Resource limits in docker-compose

## Monitoring

Metrics on port 9091 (internal). Configure Prometheus to scrape `webui:9091`, `vecpipe:9091`.

Use fluentd logging driver for centralized logs.

## Scaling

Scale stateless services: `docker compose up -d --scale vecpipe=5 --scale worker=10`

Use nginx upstream for load balancing or switch to Docker Swarm/Kubernetes.

## Troubleshooting

**Won't start:** `docker compose logs <service>`, check ports with `lsof`
**DB issues:** `docker compose exec postgres psql -U semantik -c "SELECT 1"`
**Memory:** Check `docker stats`, reduce batch size, use int8
**GPU:** Verify with `docker run --rm --gpus all nvidia/cuda:11.8.0-base nvidia-smi`

## Maintenance

### Regular Tasks

#### Daily
- Monitor service logs for errors
- Check disk usage
- Verify backup completion

#### Weekly
- Review performance metrics
- Clean old operation files
- Update container images

#### Monthly
- Security updates
- Performance optimization
- Capacity planning

### Update Procedure

```bash
# 1. Backup current state
./backup.sh

# 2. Pull latest changes
git pull origin main

# 3. Update images
docker compose pull

# 4. Rebuild custom images
docker compose build

# 5. Apply database migrations
docker compose run --rm webui alembic upgrade head

# 6. Restart services
docker compose down
docker compose up -d

# 7. Verify health
./health-check.sh
```

## Disaster Recovery

### Backup Restoration

```bash
# 1. Stop services
docker compose down

# 2. Restore PostgreSQL
docker compose up -d postgres
docker compose exec -T postgres psql -U semantik -d postgres < backup/postgres.sql

# 3. Restore Qdrant
docker compose up -d qdrant
# Upload snapshot through Qdrant API

# 4. Start remaining services
docker compose up -d
```

### Rollback Procedure

```bash
# Tag current version
docker tag semantik:latest semantik:rollback

# Deploy previous version
docker compose down
docker tag semantik:v1.0.0 semantik:latest
docker compose up -d
```

## Security Checklist

- [ ] Change all default passwords
- [ ] Generate new JWT secret key
- [ ] Enable HTTPS with valid certificates
- [ ] Configure firewall rules
- [ ] Implement rate limiting
- [ ] Enable audit logging
- [ ] Regular security updates
- [ ] Encrypt sensitive data at rest
- [ ] Use Docker secrets for credentials
- [ ] Implement network segmentation

## Performance Tuning

### Database Optimization

```sql
-- PostgreSQL tuning
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET work_mem = '16MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
```

### Redis Optimization

```bash
# Redis configuration
maxmemory 2gb
maxmemory-policy allkeys-lru
save ""  # Disable RDB saves for performance
```

### GPU Optimization

```bash
# Memory optimization
PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512

# Use TensorCores
TORCH_CUDNN_V8_API_ENABLED=1

# Enable mixed precision
USE_AMP=true
```

## Support

For deployment issues:
1. Check service logs first
2. Verify environment configuration
3. Review this deployment guide
4. Check GitHub issues
5. Contact support team
