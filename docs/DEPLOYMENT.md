# Deployment Guide

## Overview

Semantik is a containerized microservices app: Qdrant (vectors), PostgreSQL (metadata), Redis (queue), Vecpipe (search), WebUI (interface), Worker (background tasks).

## Deployment Options

1. **Docker Compose** (recommended) - Production, staging, consistent environments
2. **Kubernetes** - Large-scale, auto-scaling
3. **Manual** - Development, debugging

## Quick Start

**With wizard:**
```bash
make wizard  # Auto-config, generates secrets, starts services
```

**Manual:**
```bash
cp .env.docker.example .env
# Edit .env (replace placeholders like JWT_SECRET_KEY, POSTGRES_PASSWORD, FLOWER_*, and CONNECTOR_SECRETS_KEY)
make docker-up
```

## Configuration

**Required:**
- `JWT_SECRET_KEY` (generate: `openssl rand -hex 32`)
- `POSTGRES_PASSWORD`
- `FLOWER_USERNAME` / `FLOWER_PASSWORD` (auto-generated by wizard)
- `CONNECTOR_SECRETS_KEY` (set to a valid Fernet key, or set empty to disable connector credential storage)

**Optional:**
- `DEFAULT_EMBEDDING_MODEL` (default: Qwen/Qwen3-Embedding-0.6B)
- `DEFAULT_QUANTIZATION` (float16/int8)
- `DOCUMENT_PATH` (default: ./documents)
- Database pool settings (see `.env.docker.example`)

## Docker Deployment

**Profiles:**
- Default: Core services
- `backend`: Adds Flower
- `testing`: Adds test PostgreSQL

**Production:**
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

Production compose includes: pinned versions, JSON logging, enhanced health checks, optional nginx.

## Service Management

```bash
make docker-up                 # Start all
make docker-down               # Stop (preserves data)
docker compose down -v         # Delete everything (caution!)
docker compose ps              # Check health
docker compose --scale vecpipe=3 up -d  # Scale services
```

## Volumes

**Persistent:** `postgres_data` (critical, backup!), `qdrant_storage` (can rebuild), `redis_data`
**Bind mounts:** `./data`, `./models`, `./logs`, `./documents`

**Backup:**
```bash
docker compose exec -T postgres pg_dump -U semantik semantik > backup.sql
docker compose exec qdrant curl -X POST http://localhost:6333/snapshots
```

## Production

**Create your own `nginx.conf`** for SSL, WebSocket proxying, security headers, rate limiting.

**Security:**
- Generate secrets: `openssl rand -hex 32`
- Network isolation (frontend/backend networks)
- Read-only containers where possible
- Resource limits in docker-compose

## Monitoring

Metrics on port 9091 (internal). Configure Prometheus to scrape `webui:9091`, `vecpipe:9091`.

Use fluentd logging driver for centralized logs.

## Scaling

Scale stateless services: `docker compose up -d --scale vecpipe=5 --scale worker=10`

Use nginx upstream for load balancing or switch to Docker Swarm/Kubernetes.

## Troubleshooting

**Won't start:** `docker compose logs <service>`, check ports with `lsof`
**DB issues:** `docker compose exec postgres psql -U semantik -c "SELECT 1"`
**Memory:** Check `docker stats`, reduce batch size, use int8
**GPU:** Verify with `docker run --rm --gpus all nvidia/cuda:11.8.0-base nvidia-smi`

## Maintenance

Daily: Monitor logs, check disk
Weekly: Review metrics, clean operation files
Monthly: Security updates, performance review

**Updates:**
```bash
./backup.sh
git pull
docker compose build
docker compose run --rm webui alembic upgrade head
docker compose down && docker compose up -d
```

**Restore:**
```bash
docker compose down
docker compose up -d postgres
docker compose exec -T postgres psql -U semantik -d postgres < backup.sql
docker compose up -d
```
